<!DOCTYPE html>
<html>

<head>

    {% load static %}
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- æ‰‹åŠ¨æ·»åŠ  favicon ä»£ç  -->
    <link rel="icon" type="image/x-icon" href="{% static 'booking_system/favicon/favicon.ico' %}">
    <link rel="icon" type="image/svg+xml" href="{% static 'booking_system/favicon/favicon.svg' %}">
    <link rel="icon" type="image/png" sizes="96x96" href="{% static 'booking_system/favicon/favicon-96x96.png' %}">
    <link rel="apple-touch-icon" href="{% static 'booking_system/favicon/apple-touch-icon.png' %}">
    <link rel="manifest" href="{% static 'booking_system/favicon/site.webmanifest' %}">
    <meta name="theme-color" content="#ffffff">

    <title>{{ title }} - å·¥ä½œå°</title>
    <style>
        /* ä½¿ç”¨ä¸ doctor_all.html ç±»ä¼¼çš„æ ·å¼ï¼Œè¿™é‡Œåªæ·»åŠ æ–°æ ·å¼ */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
        }

        .doctor-container {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 250px;
            height: 100vh;
            background-color: #2c3e50;
            color: white;
            padding: 20px 0;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
        }

        .sidebar h2 {
            text-align: center;
            color: #ecf0f1;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 2px solid #34495e;
        }

        .sidebar-menu {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .sidebar-menu li {
            margin: 0;
        }

        .sidebar-menu a {
            display: block;
            padding: 15px 25px;
            color: #ecf0f1;
            text-decoration: none;
            transition: all 0.3s;
            border-left: 4px solid transparent;
        }

        .sidebar-menu a:hover {
            background-color: #34495e;
            border-left: 4px solid #3498db;
        }

        .sidebar-menu a.active {
            background-color: #34495e;
            border-left: 4px solid #2ecc71;
            font-weight: bold;
        }

        .main-content {
            flex: 1;
            padding: 20px;
            margin-left: 250px;
            min-height: 100vh;
        }

        .welcome-message {
            background: white;
            border-radius: 8px;
            padding: 12px 25px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .welcome-message h2 {
            color: #2c3e50;
            margin: 0;
        }

        /* è¡¨å•æ ·å¼ */
        .form-container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 16px;
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .error {
            color: #e74c3c;
            font-size: 14px;
            margin-top: 5px;
        }

        /* è‡ªåŠ¨å®Œæˆä¸‹æ‹‰æ¡†æ ·å¼ */
        .autocomplete-dropdown {
            position: absolute;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            width: 100%;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .autocomplete-item {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }

        .autocomplete-item:hover {
            background-color: #f5f5f5;
        }

        .autocomplete-item:last-child {
            border-bottom: none;
        }

        /* æŒ‰é’®æ ·å¼ */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: #2ecc71;
            color: white;
        }

        .btn-primary:hover {
            background: #27ae60;
        }

        .btn-secondary {
            background: #95a5a6;
            color: white;
        }

        .btn-secondary:hover {
            background: #7f8c8d;
        }

        /* å“åº”å¼è°ƒæ•´ */
        @media (max-width: 992px) {
            .sidebar {
                width: 220px;
                transform: translateX(-220px);
                transition: transform 0.3s ease;
            }

            .sidebar.active {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
                width: 100%;
            }
        }

        /* ç§»åŠ¨ç«¯èœå•æŒ‰é’® */
        .mobile-menu-toggle {
            display: none;
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1500;
            background: #2ecc71;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 10px 15px;
            cursor: pointer;
            font-size: 16px;
        }

        @media (max-width: 992px) {
            .mobile-menu-toggle {
                display: block;
            }
        }

        /* è¡¨å•å¸ƒå±€ */
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }

        /* ä¾§è¾¹æ åº•éƒ¨æ ·å¼ */
        .sidebar-footer {
            margin-top: auto;
            padding: 20px 25px;
            border-top: 1px solid #34495e;
        }

        .logout-form-sidebar {
            width: 100%;
        }

        .logout-btn-sidebar {
            width: 100%;
            background: #e74c3c;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: background 0.3s;
        }

        .logout-btn-sidebar:hover {
            background: #c0392b;
        }
    </style>
</head>

<body>
    <!-- ç§»åŠ¨ç«¯èœå•æŒ‰é’® -->
    <button class="mobile-menu-toggle" id="mobileMenuToggle">â˜° èœå•</button>

    <div class="doctor-container">
        <!-- ä¾§è¾¹æ  -->
        <div class="sidebar" id="sidebar">
            <h2>å·¥ä½œå°</h2>
            <ul class="sidebar-menu">
                <li><a href="{% url 'doctor_index' %}"><i>ğŸ </i> ä»ªè¡¨æ¿</a></li>
                <li><a href="{% url 'doctor_urge' %}"><i>ğŸ”¥</i> å¤„ç†å‚¬å•
                        {% if request.session.urge_count > 0 %}
                        <span
                            style="float: right; background: #e74c3c; color: white; padding: 2px 8px; border-radius: 10px; font-size: 12px;">
                            {{ request.session.urge_count }}
                        </span>
                        {% endif %}
                    </a></li>
                <li><a href="{% url 'doctor_respond' %}"><i>ğŸ’¬</i> å›åº”é¢„çº¦
                        {% if request.session.unresponded_count > 0 %}
                        <span
                            style="float: right; background: #f39c12; color: white; padding: 2px 8px; border-radius: 10px; font-size: 12px;">
                            {{ request.session.unresponded_count }}
                        </span>
                        {% endif %}
                    </a></li>
                <li><a href="{% url 'doctor_process' %}"><i>âš™ï¸</i> å¤„ç†é¢„çº¦
                        {% if request.session.unprocessed_count > 0 %}
                        <span
                            style="float: right; background: #3498db; color: white; padding: 2px 8px; border-radius: 10px; font-size: 12px;">
                            {{ request.session.unprocessed_count }}
                        </span>
                        {% endif %}
                    </a></li>
                <li><a href="{% url 'doctor_all' %}"><i>ğŸ“‹</i> é¢„çº¦ç®¡ç†</a></li>
                <li><a href="{% url 'patients_info' %}" class="active"><i>ğŸ“</i> ç”¨æˆ·æ¡£æ¡ˆ</a></li>
                <li><a href="{% url 'user_accounts' %}"><i>ğŸ‘¥</i> ç”¨æˆ·è´¦æˆ·</a></li>
                <li><a href="{% url 'data_backup' %}"><i>ğŸ’¾</i> æ•°æ®å¤‡ä»½</a></li>
            </ul>
            <div class="sidebar-footer">
                <form method="post" action="{% url 'logout' %}" class="logout-form-sidebar">
                    {% csrf_token %}
                    <button type="submit" class="logout-btn-sidebar">
                        <i>ğŸšª</i> é€€å‡ºç™»å½•
                    </button>
                </form>
            </div>
        </div>

        <!-- ä¸»å†…å®¹åŒº -->
        <div class="main-content">
            <!-- æ¬¢è¿ä¿¡æ¯ -->
            <div class="welcome-message">
                <h2>{{ title }}</h2>
                <a href="{% url 'patients_info' %}" class="btn btn-secondary">
                    â† è¿”å›åˆ—è¡¨
                </a>
            </div>

            <div class="form-container">
                <form method="post" id="profileForm">
                    {% csrf_token %}

                    <div class="form-row">
                        <div class="form-group">
                            <label for="id_name">{{ form.name.label }}</label>
                            {{ form.name }}
                            {% if form.name.errors %}
                            <div class="error">{{ form.name.errors }}</div>
                            {% endif %}
                        </div>

                        <div class="form-group">
                            <label for="id_account_email">{{ form.account_email.label }}</label>
                            <div class="autocomplete-container" style="position: relative; width: 100%;">
                                {{ form.account_email }}
                                <div id="autocompleteResults" style="display: none;
                    position: absolute;
                    top: 100%;
                    left: 0;
                    width: 100%;
                    background: white;
                    border: 1px solid #ccc;
                    border-radius: 4px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                    z-index: 10000;
                    max-height: 200px;
                    overflow-y: auto;
                    margin-top: 2px;">
                                </div>
                            </div>
                            <small style="color: #666;">è¾“å…¥é‚®ç®±è‡ªåŠ¨æœç´¢åŒ¹é…çš„è´¦å·ï¼Œç•™ç©ºè¡¨ç¤ºæ— å…³è”è´¦å·</small>
                            {% if form.account_email.errors %}
                            <div class="error">{{ form.account_email.errors }}</div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="id_wechat_id">{{ form.wechat_id.label }}</label>
                            {{ form.wechat_id }}
                            {% if form.wechat_id.errors %}
                            <div class="error">{{ form.wechat_id.errors }}</div>
                            {% endif %}
                        </div>

                        <div class="form-group">
                            <label for="id_notes">{{ form.notes.label }}</label>
                            {{ form.notes }}
                            {% if form.notes.errors %}
                            <div class="error">{{ form.notes.errors }}</div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="id_overview">{{ form.overview.label }}</label>
                        {{ form.overview }}
                        {% if form.overview.errors %}
                        <div class="error">{{ form.overview.errors }}</div>
                        {% endif %}
                    </div>

                    <div class="form-group">
                        <label for="id_initial_record">{{ form.initial_record.label }}</label>
                        {{ form.initial_record }}
                        <small style="color: #666;">åˆ›å»ºæ¡£æ¡ˆæ—¶å¯ä»¥æ·»åŠ ä¸€æ¡åˆå§‹è®°å½•</small>
                        {% if form.initial_record.errors %}
                        <div class="error">{{ form.initial_record.errors }}</div>
                        {% endif %}
                    </div>

                    <div style="margin-top: 30px; display: flex; gap: 10px;">
                        <button type="submit" class="btn btn-primary">ä¿å­˜æ¡£æ¡ˆ</button>
                        <a href="{% url 'patients_info' %}" class="btn btn-secondary">å–æ¶ˆ</a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // ç§»åŠ¨ç«¯èœå•åˆ‡æ¢åŠŸèƒ½
        const mobileMenuToggle = document.getElementById('mobileMenuToggle');
        const sidebar = document.getElementById('sidebar');
        if (mobileMenuToggle && sidebar) {
            mobileMenuToggle.addEventListener('click', function() {
                sidebar.classList.toggle('active');
            });
            document.addEventListener('click', function(event) {
                if (!sidebar.contains(event.target) && !mobileMenuToggle.contains(event.target)) {
                    sidebar.classList.remove('active');
                }
            });
        }
        
        // è·å–URLå‚æ•°çš„å‡½æ•°
        function getUrlParameter(name) {
            name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
            const regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
            const results = regex.exec(location.search);
            return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
        }
        
        // æ£€æŸ¥æ˜¯å¦æœ‰account_emailå‚æ•°å¹¶è‡ªåŠ¨å¡«å……
        const accountEmail = getUrlParameter('account_email');
        if (accountEmail) {
            console.log('æ£€æµ‹åˆ°è´¦æˆ·é‚®ç®±å‚æ•°:', accountEmail);
            
            // ç­‰å¾…ä¸€å°æ®µæ—¶é—´ç¡®ä¿DOMå®Œå…¨åŠ è½½
            setTimeout(function() {
                const accountInput = document.getElementById('id_account_email');
                if (accountInput) {
                    console.log('æ‰¾åˆ°è´¦æˆ·è¾“å…¥æ¡†ï¼Œè®¾ç½®å€¼ä¸º:', accountEmail);
                    accountInput.value = accountEmail;
                    
                    // è§¦å‘inputäº‹ä»¶ä»¥æ¿€æ´»è‡ªåŠ¨å®Œæˆ
                    const inputEvent = new Event('input', { bubbles: true });
                    accountInput.dispatchEvent(inputEvent);
                    
                    // è§¦å‘focusäº‹ä»¶
                    const focusEvent = new Event('focus', { bubbles: true });
                    accountInput.dispatchEvent(focusEvent);
                    
                    // å¦‚æœè‡ªåŠ¨å®ŒæˆåŠŸèƒ½å·²åˆå§‹åŒ–ï¼Œè°ƒç”¨æœç´¢
                    if (typeof window.searchAccounts === 'function') {
                        console.log('è°ƒç”¨è‡ªåŠ¨å®Œæˆæœç´¢å‡½æ•°');
                        setTimeout(() => {
                            window.searchAccounts(accountEmail);
                        }, 300);
                    }
                } else {
                    console.error('æœªæ‰¾åˆ°id_account_emailè¾“å…¥æ¡†');
                }
            }, 100);
        }
        
        // è‡ªåŠ¨å®ŒæˆåŠŸèƒ½åˆå§‹åŒ– - å°†å…¶è®¾ä¸ºå…¨å±€å‡½æ•°
        const accountInput = document.getElementById('id_account_email');
        const autocompleteResults = document.getElementById('autocompleteResults');
        
        if (accountInput && autocompleteResults) {
            console.log('è‡ªåŠ¨å®ŒæˆåŠŸèƒ½åˆå§‹åŒ–');
            
            // ç¡®ä¿è¾“å…¥æ¡†çš„å®¹å™¨æœ‰ç›¸å¯¹å®šä½
            const container = accountInput.parentElement;
            if (container) {
                container.style.position = 'relative';
            }
            
            let timeoutId;
            
            // æœç´¢è´¦å·å‡½æ•° - è®¾ä¸ºå…¨å±€å‡½æ•°ä»¥ä¾¿å…¶ä»–åœ°æ–¹è°ƒç”¨
            window.searchAccounts = function(query) {
                console.log('æœç´¢è´¦å·:', query);
                
                // æ„å»ºURL
                const url = `/doctor/autocomplete/accounts/?q=${encodeURIComponent(query)}`;
                
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                autocompleteResults.innerHTML = '<div class="autocomplete-item">æœç´¢ä¸­...</div>';
                autocompleteResults.style.display = 'block';
                
                // å‘é€AJAXè¯·æ±‚
                fetch(url)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        // æ¸…ç©ºä¹‹å‰çš„ç»“æœ
                        autocompleteResults.innerHTML = '';
                        
                        if (!Array.isArray(data) || data.length === 0) {
                            autocompleteResults.innerHTML = '<div class="autocomplete-item">æœªæ‰¾åˆ°åŒ¹é…çš„è´¦å·</div>';
                            return;
                        }
                        
                        // æ·»åŠ ç»“æœé¡¹
                        data.forEach((item, index) => {
                            const itemElement = document.createElement('div');
                            itemElement.className = 'autocomplete-item';
                            itemElement.textContent = `${item.email} (ID: ${item.id})`;
                            itemElement.dataset.email = item.email;
                            
                            // ç¬¬ä¸€ä¸ªç»“æœé»˜è®¤é€‰ä¸­
                            if (index === 0) {
                                itemElement.classList.add('selected');
                            }
                            
                            itemElement.addEventListener('click', function() {
                                console.log('é€‰æ‹©è´¦å·:', item.email);
                                accountInput.value = item.email;
                                autocompleteResults.style.display = 'none';
                            });
                            
                            itemElement.addEventListener('mouseover', function() {
                                // ç§»é™¤æ‰€æœ‰é¡¹çš„é€‰ä¸­çŠ¶æ€
                                autocompleteResults.querySelectorAll('.autocomplete-item').forEach(el => {
                                    el.classList.remove('selected');
                                });
                                // æ·»åŠ å½“å‰é¡¹çš„é€‰ä¸­çŠ¶æ€
                                this.classList.add('selected');
                            });
                            
                            autocompleteResults.appendChild(itemElement);
                        });
                        
                        // ç¡®ä¿ä¸‹æ‹‰æ¡†æ˜¾ç¤º
                        autocompleteResults.style.display = 'block';
                        
                        console.log('ä¸‹æ‹‰æ¡†å·²æ˜¾ç¤ºï¼ŒåŒ…å«', data.length, 'ä¸ªç»“æœ');
                    })
                    .catch(error => {
                        console.error('æœç´¢è´¦å·å¤±è´¥:', error);
                        autocompleteResults.innerHTML = '<div class="autocomplete-item">æœç´¢å¤±è´¥</div>';
                    });
            };
            
            // è¾“å…¥äº‹ä»¶å¤„ç†
            accountInput.addEventListener('input', function() {
                const query = this.value.trim();
                
                // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
                clearTimeout(timeoutId);
                
                // ç«‹å³éšè—ä¸‹æ‹‰æ¡†
                autocompleteResults.style.display = 'none';
                
                // å¦‚æœæŸ¥è¯¢å†…å®¹å°‘äº2ä¸ªå­—ç¬¦ï¼Œä¸æœç´¢
                if (query.length < 2) {
                    return;
                }
                
                // å»¶è¿Ÿæœç´¢ï¼Œé¿å…é¢‘ç¹è¯·æ±‚
                timeoutId = setTimeout(() => {
                    window.searchAccounts(query);
                }, 300);
            });
            
            // ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹éšè—ä¸‹æ‹‰æ¡†
            document.addEventListener('click', function(event) {
                if (!accountInput.contains(event.target) && 
                    !autocompleteResults.contains(event.target)) {
                    autocompleteResults.style.display = 'none';
                }
            });
            
            // é”®ç›˜äº‹ä»¶å¤„ç†
            accountInput.addEventListener('keydown', function(event) {
                const items = autocompleteResults.querySelectorAll('.autocomplete-item');
                if (items.length === 0) return;
                
                let selectedIndex = -1;
                
                // æ‰¾åˆ°å½“å‰é€‰ä¸­çš„é¡¹
                items.forEach((item, index) => {
                    if (item.classList.contains('selected')) {
                        selectedIndex = index;
                    }
                });
                
                if (event.key === 'ArrowDown') {
                    event.preventDefault();
                    if (selectedIndex < items.length - 1) {
                        if (selectedIndex >= 0) {
                            items[selectedIndex].classList.remove('selected');
                        }
                        selectedIndex++;
                        items[selectedIndex].classList.add('selected');
                    }
                } else if (event.key === 'ArrowUp') {
                    event.preventDefault();
                    if (selectedIndex > 0) {
                        items[selectedIndex].classList.remove('selected');
                        selectedIndex--;
                        items[selectedIndex].classList.add('selected');
                    }
                } else if (event.key === 'Enter' && selectedIndex >= 0) {
                    event.preventDefault();
                    const selectedItem = items[selectedIndex];
                    accountInput.value = selectedItem.dataset.email;
                    autocompleteResults.style.display = 'none';
                } else if (event.key === 'Escape') {
                    autocompleteResults.style.display = 'none';
                }
            });
            
            // è¾“å…¥æ¡†è·å–ç„¦ç‚¹æ—¶ï¼Œå¦‚æœå·²æœ‰å€¼ï¼Œåˆ™æ˜¾ç¤ºåŒ¹é…ç»“æœ
            accountInput.addEventListener('focus', function() {
                const query = this.value.trim();
                if (query.length >= 2) {
                    window.searchAccounts(query);
                }
            });
            
            console.log('è‡ªåŠ¨å®ŒæˆåŠŸèƒ½åˆå§‹åŒ–å®Œæˆ');
        }
    });
    </script>
</body>

</html>