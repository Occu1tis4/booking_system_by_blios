{% extends "app/base_user.html" %}
{% load static %}

{% block title %}é¦–é¡µ{% endblock %}

{% block content %}
    {% if user.is_authenticated %}
        <!-- ç”¨æˆ·ä¿¡æ¯æ  -->
        <div class="user-info-card">
            <div class="user-welcome">
                <div class="user-details">
                    <div class="user-email">
                        <img src="{% static 'booking_system/favicon/web-app-manifest-192x192.png' %}" class="welcome-icon" alt="æ¬¢è¿å›¾æ ‡">
                        æ¬¢è¿å›åˆ°ç¼¥ç¼ˆæ—…ï¼
                    </div>
                    <div class="user-stats">
                        <div class="stat-item">
                            <div class="stat-value {% if unfinished_count >= 3 %}stat-limit{% endif %}">
                                {{ unfinished_count }}/3
                            </div>
                            <div class="stat-label">æœªå¤„ç†é¢„çº¦</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">
                                {{ daily_creation_left }}
                            </div>
                            <div class="stat-label">ä»Šæ—¥å¯åˆ›å»º</div>
                        </div>
                    </div>
                </div>
            </div>
            
            {% if urges_left == 0 %}
            <div style="color: var(--warning-color); font-size: 14px; text-align: center;">
                âš ï¸ æœ¬å‘¨å‚¬å•æœºä¼šå·²ç”¨å®Œ
            </div>
            {% endif %}
        </div>

        <!-- å…¬å‘Šæ  -->
        <div class="announcement-card">
            <a href="{% url 'announcement_list' %}" class="announcement-link">
                <div class="announcement-header">
                    <div class="announcement-title">
                        <span class="announcement-icon">ğŸ“¢</span>
                        <span>å…¬å‘Šï¼ˆå¯åŠ ä¼¯é‡Œæ¬§æ–¯å¾®ä¿¡ï¼šHypnocculsisï¼‰</span>
                        {% if unread_announcements_count > 0 %}
                        <span class="unread-badge" id="unreadBadge">
                            {{ unread_announcements_count }}
                        </span>
                        {% endif %}
                    </div>
                    <div class="announcement-arrow">â€º</div>
                </div>
                
                {% if all_announcements %}
                    <div class="announcement-preview">
                        <div class="latest-announcement">
                            <div class="announcement-time">
                                {{ all_announcements.0.created_at|date:"Y-m-d H:i" }}
                            </div>
                            <div class="announcement-content-preview">
                                {{ all_announcements.0.title }}
                            </div>
                        </div>
                        {% if all_announcements|length > 1 %}
                        <div class="more-announcements">
                            è¿˜æœ‰ {{ all_announcements|length|add:"-1" }} æ¡å†å²å…¬å‘Š...
                        </div>
                        {% endif %}
                    </div>
                {% else %}
                    <div class="announcement-preview">
                        <div class="no-announcement">
                            æš‚æ— ç³»ç»Ÿå…¬å‘Š
                        </div>
                    </div>
                {% endif %}
            </a>
        </div>

        <!-- æ¶ˆæ¯æç¤º -->
        {% if messages %}
        <div class="messages">
            {% for message in messages %}
            <div class="message {{ message.tags }}">
                {% if message.tags == 'success' %}âœ…{% else %}âŒ{% endif %}
                {{ message }}
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <!-- ä¸»åŠŸèƒ½æŒ‰é’® -->
        <div class="main-buttons">
            <!-- åˆ›å»ºé¢„çº¦æŒ‰é’® -->
            <a href="{% url 'create_appointment' %}" class="main-btn btn-create">
                <div class="btn-icon">â•</div>
                <div class="btn-content">
                    <div class="btn-title">åˆ›å»ºé¢„çº¦</div>
                    <div class="btn-desc">
                        {% if unfinished_count >= 3 %}
                        å·²è¾¾ä¸Šé™ï¼ˆ3/3ï¼‰
                        {% else %}
                        ä»Šæ—¥è¿˜å¯åˆ›å»º {{ daily_creation_left }} æ¬¡
                        {% endif %}
                    </div>
                </div>
                {% if unfinished_count >= 3 %}
                <div class="badge">å·²è¾¾ä¸Šé™</div>
                {% endif %}
            </a>

            <!-- æŸ¥çœ‹é¢„çº¦æŒ‰é’® -->
            <a href="{% url 'my_appointments' %}" class="main-btn btn-view">
                <div class="btn-icon">ğŸ“‹</div>
                <div class="btn-content">
                    <div class="btn-title">æˆ‘çš„é¢„çº¦</div>
                    <div class="btn-desc">
                        {% if unfinished_count > 0 %}
                        {{ unfinished_count }} ä¸ªå¾…å¤„ç†é¢„çº¦
                        {% else %}
                        æš‚æ— è¿›è¡Œä¸­çš„é¢„çº¦
                        {% endif %}
                    </div>
                </div>
                {% if unfinished_count > 0 %}
                <div class="badge">{{ unfinished_count }}</div>
                {% endif %}
            </a>

            <!-- æŸ¥çœ‹æ¡£æ¡ˆæŒ‰é’® -->
            <a href="{% url 'view_my_profile' %}" class="main-btn btn-profile">
                <div class="btn-icon">ğŸ“</div>
                <div class="btn-content">
                    <div class="btn-title">ä¸ªäººæ¡£æ¡ˆ</div>
                    <div class="btn-desc">æŸ¥çœ‹æ‚¨æ‹¥æœ‰çš„æ¡£æ¡ˆ</div>
                </div>
            </a>
        </div>

        <!-- é€€å‡ºç™»å½• -->
        <div class="logout-container">
            <form method="post" action="{% url 'logout' %}" style="display: inline;">
                {% csrf_token %}
                <button type="submit" class="logout-btn">
                    ğŸšª é€€å‡ºç™»å½•
                </button>
            </form>
        </div>

    {% else %}
        <!-- æœªç™»å½•çŠ¶æ€ -->
        <div class="guest-container">
            <div class="guest-title">ä¼¯é‡Œæ¬§æ–¯çš„é¢„çº¦ç³»ç»Ÿ</div>
            <div class="guest-subtitle">ä¸“ä¸šã€é«˜æ•ˆã€è´´å¿ƒçš„é¢„çº¦æœåŠ¡</div>
            
            <div class="guest-buttons">
                <a href="{% url 'login' %}" class="guest-btn login">
                    ç™»å½•è´¦æˆ·
                </a>
                <a href="{% url 'register' %}" class="guest-btn">
                    æ³¨å†Œæ–°è´¦å·
                </a>
            </div>
            
            <div style="margin-top: 40px; color: rgba(255, 255, 255, 0.6); font-size: 14px;">
                <p>âœ¨ æ¯æ—¥æœ€å¤šæ³¨å†Œ 10 ä¸ªæ–°è´¦å·</p>
                <p>ğŸ“± ä¸“ä¸ºç§»åŠ¨ç«¯ä¼˜åŒ–è®¾è®¡</p>
                <p>ğŸ”’ æ‚¨çš„ä¿¡æ¯å®‰å…¨æœ‰ä¿éšœ</p>
            </div>
        </div>
    {% endif %}
{% endblock %}

{% block extra_css %}
<style>
    /* å…¬å‘Šæ æ ·å¼ */
    .announcement-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 12px;
        padding: 16px;
        margin: 20px 0;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s ease;
    }
    
    .announcement-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
    }
    
    .announcement-link {
        text-decoration: none;
        color: white;
        display: block;
    }
    
    .announcement-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
    }
    
    .announcement-title {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 18px;
        font-weight: 600;
    }
    
    .announcement-icon {
        font-size: 20px;
    }
    
    .unread-badge {
        background: #ff4757;
        color: white;
        font-size: 12px;
        padding: 2px 8px;
        border-radius: 10px;
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.7; }
        100% { opacity: 1; }
    }
    
    .announcement-arrow {
        font-size: 24px;
        color: rgba(255, 255, 255, 0.8);
    }
    
    .announcement-preview {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border-radius: 8px;
        padding: 12px;
    }
    
    .latest-announcement {
        margin-bottom: 8px;
    }
    
    .announcement-time {
        font-size: 12px;
        color: rgba(255, 255, 255, 0.8);
        margin-bottom: 4px;
    }
    
    .announcement-content-preview {
        font-size: 14px;
        line-height: 1.4;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
    
    .more-announcements {
        font-size: 12px;
        color: rgba(255, 255, 255, 0.8);
        text-align: center;
        padding-top: 8px;
        border-top: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .no-announcement {
        text-align: center;
        font-size: 14px;
        color: rgba(255, 255, 255, 0.8);
        padding: 8px 0;
    }
    
    /* è°ƒæ•´ç°æœ‰å¸ƒå±€ - ä¿®æ”¹ç”¨æˆ·ä¿¡æ¯æ æ ·å¼ */
    .user-info-card {
        background: var(--card-bg);
        border-radius: var(--border-radius);
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: var(--shadow);
        backdrop-filter: blur(10px);
    }
    
    .user-details {
        flex: 1;
    }
    
    .user-email {
        font-size: 28px;  /* ä» 16px æ”¹ä¸º 20px */
        font-weight: 750;  /* ä» 600 æ”¹ä¸º 700 */
        color: var(--dark-text);
        margin-top: 7px;
        margin-bottom: 18px;
        line-height: 1.4;
        display: flex;
        align-items: center;
        gap: 10px; /* å›¾æ ‡å’Œæ–‡å­—ä¹‹é—´çš„é—´è· */
    }

    .welcome-icon {
        width: 50px; /* æ ¹æ®å®é™…å›¾æ ‡å°ºå¯¸è°ƒæ•´ */
        height: 50px;
        object-fit: contain;
        border-radius: 50%; /* å¯é€‰ï¼šå¦‚æœå›¾æ ‡æ˜¯åœ†å½¢çš„ */
        box-shadow: 0 2px 5px rgba(0,0,0,0.1); /* å¯é€‰ï¼šæ·»åŠ è½»å¾®é˜´å½± */
    }
    
    .user-stats {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
    }
    
    .main-buttons {
        margin-top: 20px;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    // æ·»åŠ æŒ‰é’®ç‚¹å‡»åŠ¨ç”»
    document.addEventListener('DOMContentLoaded', function() {
        const buttons = document.querySelectorAll('.main-btn');
        
        buttons.forEach(button => {
            button.addEventListener('click', function(e) {
                if (this.classList.contains('disabled')) {
                    e.preventDefault();
                    return false;
                }
                
                // æ·»åŠ ç‚¹å‡»åé¦ˆ
                this.style.transform = 'scale(0.98)';
                setTimeout(() => {
                    this.style.transform = '';
                }, 200);
            });
        });
        
        // æ£€æŸ¥æŒ‰é’®çŠ¶æ€
        const createBtn = document.querySelector('.btn-create');
        if (createBtn) {
            const badge = createBtn.querySelector('.badge');
            if (badge && badge.textContent === 'å·²è¾¾ä¸Šé™') {
                createBtn.classList.add('disabled');
                createBtn.style.opacity = '0.7';
                createBtn.style.cursor = 'not-allowed';
            }
        }
        
        // å…¬å‘Šç‚¹å‡»æ•ˆæœ
        const announcementCard = document.querySelector('.announcement-card');
        if (announcementCard) {
            announcementCard.addEventListener('click', function() {
                // æ·»åŠ ç‚¹å‡»åé¦ˆ
                this.style.transform = 'scale(0.98)';
                setTimeout(() => {
                    this.style.transform = '';
                }, 200);
            });
        }
        
        // å¦‚æœæœ‰æœªè¯»å…¬å‘Šï¼Œæ·»åŠ æé†’æ•ˆæœ
        const unreadBadge = document.getElementById('unreadBadge');
        if (unreadBadge) {
            // æ¯5ç§’é—ªçƒä¸€æ¬¡
            setInterval(() => {
                unreadBadge.style.opacity = unreadBadge.style.opacity === '0.7' ? '1' : '0.7';
            }, 5000);
        }
    });
</script>
{% endblock %}