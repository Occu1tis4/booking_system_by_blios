{% extends "app/base_user.html" %}

{% block title %}æˆ‘çš„é¢„çº¦{% endblock %}

{% block extra_css %}
<style>
    /* è¿”å›æŒ‰é’®æ ·å¼ */
    .back-btn {
        background: var(--secondary-color);
        color: white;
        border: none;
        padding: 12px 20px;
        border-radius: var(--border-radius);
        font-size: 16px;
        cursor: pointer;
        transition: var(--transition);
        display: inline-flex;
        align-items: center;
        gap: 8px;
        text-decoration: none;
        margin-bottom: 20px;
    }
    
    .back-btn:hover {
        background: #2980b9;
        transform: translateX(-3px);
    }
    
    /* é¡µé¢æ ‡é¢˜æ ·å¼ - æ–°å¢ */
    .appointments-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
        flex-wrap: wrap;
        gap: 10px;
        padding: 15px;
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.9) 0%, rgba(248, 249, 250, 0.9) 100%);
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
        border-left: 5px solid var(--accent-color);
        position: relative;
        overflow: hidden;
    }
    
    .appointments-header::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 3px;
        background: linear-gradient(90deg, var(--primary-color), var(--accent-color), var(--secondary-color));
    }
    
    .header-title {
        font-size: 24px;
        font-weight: 700;
        color: var(--dark-text);
        position: relative;
        display: inline-flex;
        align-items: center;
        gap: 10px;
    }
    
    .appointment-count {
        background: linear-gradient(135deg, var(--accent-color) 0%, #8e44ad 100%);
        color: white;
        padding: 8px 18px;
        border-radius: 20px;
        font-size: 15px;
        font-weight: 600;
        box-shadow: 0 3px 10px rgba(155, 89, 182, 0.3);
        transition: var(--transition);
        border: 2px solid rgba(255, 255, 255, 0.2);
    }
    
    .appointment-count:hover {
        transform: scale(1.05);
        box-shadow: 0 5px 15px rgba(155, 89, 182, 0.4);
    }
    
    .appointments-list {
        display: grid;
        grid-template-columns: 1fr;
        gap: 15px;
    }
    
    .appointment-card {
        background: var(--card-bg);
        border-radius: var(--border-radius);
        padding: 20px;
        box-shadow: var(--shadow);
        border-left: 5px solid var(--primary-color);
        transition: var(--transition);
        position: relative;
        overflow: hidden;
    }
    
    .appointment-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
    }
    
    .appointment-card.deleted {
        opacity: 0.7;
        border-left-color: var(--light-text);
    }
    
    .appointment-card.urgent {
        border-left-color: var(--warning-color);
        background: #fff9e6;
    }
    
    .appointment-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 15px;
    }
    
    .patient-name {
        font-size: 18px;
        font-weight: 600;
        color: var(--dark-text);
    }
    
    .status-badge {
        padding: 6px 14px;
        border-radius: 15px;
        font-size: 13px;
        font-weight: 600;
        color: white;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }
    
    .status-waiting { background: #95a5a6; }
    .status-responded { background: var(--secondary-color); }
    .status-processed { background: var(--primary-color); }
    .status-urged { background: var(--warning-color); }
    .status-deleted { background: var(--light-text); }
    
    .appointment-info {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
        margin-bottom: 15px;
    }
    
    .info-item {
        font-size: 14px;
    }
    
    .info-label {
        color: var(--light-text);
        font-size: 12px;
        margin-bottom: 3px;
    }
    
    .info-value {
        font-weight: 500;
        word-break: break-word;
    }
    
    .annotation-box {
        background: var(--light-bg);
        padding: 12px 15px;
        border-radius: 8px;
        margin: 15px 0;
        border-left: 3px solid var(--secondary-color);
    }
    
    .annotation-label {
        font-size: 12px;
        color: var(--light-text);
        margin-bottom: 5px;
        display: flex;
        align-items: center;
        gap: 5px;
    }
    
    .annotation-content {
        font-size: 14px;
        color: var(--dark-text);
        line-height: 1.5;
    }
    
    .actions {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px solid #eee;
    }
    
    .action-btn {
        padding: 8px 15px;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: var(--transition);
        text-decoration: none;
        border: none;
        display: inline-flex;
        align-items: center;
        gap: 5px;
    }
    
    .action-btn.urge {
        background: var(--warning-color);
        color: white;
    }
    
    .action-btn.modify {
        background: var(--secondary-color);
        color: white;
    }
    
    .action-btn.delete {
        background: var(--danger-color);
        color: white;
    }
    
    .action-btn:hover {
        opacity: 0.9;
        transform: translateY(-1px);
        box-shadow: 0 3px 8px rgba(0, 0, 0, 0.2);
    }
    
    .action-btn:disabled,
    .action-btn.disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }
    
    .empty-state {
        text-align: center;
        padding: 50px 20px;
        color: var(--light-text);
        background: rgba(255, 255, 255, 0.8);
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
        margin-top: 20px;
    }
    
    .empty-icon {
        font-size: 48px;
        margin-bottom: 20px;
        opacity: 0.5;
    }
    
    .queue-position {
        display: inline-flex;
        align-items: center;
        gap: 5px;
        background: #e3f2fd;
        color: #1976d2;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 13px;
        font-weight: 600;
    }
    
    .queue-position .icon {
        animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }
    
    /* å“åº”å¼è°ƒæ•´ */
    @media (max-width: 480px) {
        .appointments-header {
            flex-direction: column;
            align-items: flex-start;
        }
        
        .header-title {
            font-size: 20px;
        }
        
        .appointment-count {
            align-self: flex-end;
        }
    }
</style>
{% endblock %}

{% block content %}
    <!-- è¿”å›æŒ‰é’® -->
    <a href="{% url 'index' %}" class="back-btn">â† è¿”å›é¦–é¡µ</a>
    
    <div class="appointments-header">
        <div class="header-title">æˆ‘çš„é¢„çº¦</div>
        <div class="appointment-count">
            å…± {{ appointments|length }} ä¸ªé¢„çº¦
        </div>
    </div>
    
    <!-- å‚¬å•çŠ¶æ€æç¤º -->
    {% if urges_left == 0 %}
    <div class="message error" style="margin-bottom: 20px;">
        âš ï¸ æœ¬å‘¨å‚¬å•æœºä¼šå·²ç”¨å®Œ
    </div>
    {% else %}
    <div class="message success" style="margin-bottom: 20px;">
        âœ… æœ¬å‘¨è¿˜å¯å‚¬å• {{ urges_left }} æ¬¡
    </div>
    {% endif %}
    
    {% if appointments %}
    <div class="appointments-list">
        {% for app in appointments %}
        <div class="appointment-card {% if app.is_deleted %}deleted{% endif %} {% if app.is_urged %}urgent{% endif %}">
            <div class="appointment-header">
                <div class="patient-name">{{ app.patient_name }}</div>
                <div class="status-badge {% if app.is_deleted %}status-deleted
                    {% elif app.is_processed %}status-processed
                    {% elif app.is_urged %}status-urged
                    {% elif app.is_responded %}status-responded
                    {% else %}status-waiting{% endif %}">
                    {% if app.is_deleted %}
                    å·²åˆ é™¤
                    {% elif app.is_processed %}
                    å·²å¤„ç†
                    {% elif app.is_urged %}
                    å·²å‚¬å•
                    {% elif app.is_responded %}
                    å·²å›åº”
                    {% else %}
                    ç­‰å¾…å›åº”
                    {% endif %}
                </div>
            </div>
            
            <div class="appointment-info">
                <div class="info-item">
                    <div class="info-label">ä¼˜å…ˆçº§</div>
                    <div class="info-value">{{ app.get_priority_display }}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">åˆ›å»ºæ—¶é—´</div>
                    <div class="info-value">{{ app.created_at|date:"m-d H:i" }}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">å¾®ä¿¡å·</div>
                    <div class="info-value">{{ app.wechat_id }}</div>
                </div>
                {% if app.queue_position %}
                <div class="info-item">
                    <div class="info-label">æ’é˜Ÿä½ç½®</div>
                    <div class="info-value">
                        <span class="queue-position">
                            <span class="icon">â³</span>
                            ç¬¬ {{ app.queue_position }} ä½
                        </span>
                    </div>
                </div>
                {% endif %}
            </div>
            
            <!-- éœ€æ±‚æè¿° -->
            <div class="info-item" style="grid-column: 1 / -1;">
                <div class="info-label">éœ€æ±‚æè¿°ï¼ˆç‚¹å‡»ä¿®æ”¹å¯æŸ¥çœ‹è¯¦æƒ…ï¼‰</div>
                <div class="info-value" style="max-height: 60px; overflow: hidden; text-overflow: ellipsis;">
                    {{ app.demand|truncatechars:100 }}
                </div>
            </div>
            
            <!-- åŒ»å¸ˆæ‰¹æ³¨ -->
            {% if app.annotation and not app.is_deleted %}
            <div class="annotation-box">
                <div class="annotation-label">ğŸ“ ä¼¯é‡Œæ¬§æ–¯çš„æ‰¹æ³¨</div>
                <div class="annotation-content">{{ app.annotation|linebreaksbr }}</div>
            </div>
            {% endif %}
            
            <!-- æ“ä½œæŒ‰é’® -->
            {% if not app.is_deleted %}
            <div class="actions">
                {% if app.is_responded and not app.is_processed %}
                    {% if not app.is_urged %}
                        {% if urges_left > 0 %}
                        <form method="post" action="{% url 'urge' app.id %}" style="display: inline;">
                            {% csrf_token %}
                            <button type="submit" class="action-btn urge"
                                    onclick="return confirm('ç¡®å®šè¦å‚¬å•å—ï¼Ÿæœ¬å‘¨å‰©ä½™{{ urges_left }}æ¬¡æœºä¼š')">
                                âš¡ å‚¬å•
                            </button>
                        </form>
                        {% else %}
                        <button class="action-btn urge disabled" disabled>æ— æ³•å‚¬å•</button>
                        {% endif %}
                    {% else %}
                    <button class="action-btn urge disabled" disabled>å·²å‚¬å•</button>
                    {% endif %}
                {% endif %}
                
                {% if app.can_modify_today_simple and not app.is_processed %}
                <a href="{% url 'update' app.id %}" class="action-btn modify">âœï¸ ä¿®æ”¹</a>
                {% else %}
                <button class="action-btn modify disabled" disabled>æ— æ³•ä¿®æ”¹</button>
                {% endif %}
                
                <form method="post" action="{% url 'delete' app.id %}" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" class="action-btn delete"
                            onclick="return confirm('ç¡®å®šåˆ é™¤ï¼Ÿåˆ é™¤åç¬¬äºŒå¤©è‡ªåŠ¨æ¸…ç†')">
                        ğŸ—‘ï¸ åˆ é™¤
                    </button>
                </form>
            </div>
            {% elif app.is_deleted %}
            <div style="color: var(--light-text); font-size: 13px; margin-top: 10px;">
                ğŸ—‘ï¸ å·²æ ‡è®°åˆ é™¤ï¼Œå°†äºæ˜å¤©è‡ªåŠ¨æ¸…ç†
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="empty-state">
        <div class="empty-icon">ğŸ“­</div>
        <div style="font-size: 18px; margin-bottom: 10px;">æš‚æ— é¢„çº¦è®°å½•</div>
        <div style="color: var(--light-text); margin-bottom: 20px;">å¿«å»åˆ›å»ºä¸€ä¸ªé¢„çº¦å§</div>
        <a href="{% url 'create_appointment' %}" class="back-btn">åˆ›å»ºç¬¬ä¸€ä¸ªé¢„çº¦</a>
    </div>
    {% endif %}
{% endblock %}